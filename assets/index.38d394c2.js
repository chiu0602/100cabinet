var autocompleteService,previousPin,kmlLayer,marker,map,inputDom,queryAddrBtn,deliveryInfoDom,predictionsDom,r=Math.floor(1e3*Math.random())+1,kml="https://chiu0602.github.io/assets/100cabinet.kml?r="+r;function init(){initCtrl(),initMap(),initData(),initKml(),initInput(),initQueryBtn()}function initCtrl(){inputDom=document.getElementById("address-input"),queryAddrBtn=document.getElementById("query-address"),deliveryInfoDom=document.getElementById("delivery-info"),predictionsDom=document.getElementById("predictions")}function initMap(){map=new google.maps.Map(document.getElementById("map"),{gestureHandling:"cooperative",minZoom:10})}function initKml(){(kmlLayer=new google.maps.KmlLayer(kml,{suppressInfoWindows:!0,preserveViewport:!1,map:map})).addListener("click",function(event){deliveryInfoDom.innerHTML="",inputDom.value="",previousPin&&previousPin.setMap(null);var latLng=event.latLng,marker=new google.maps.Marker({position:latLng,map:map}),marker=(previousPin=marker,event.featureData.infoWindowHtml);deliveryInfoDom.innerHTML=marker,(new google.maps.Geocoder).geocode({location:latLng},function(results,status){status===google.maps.GeocoderStatus.OK&&results[0]&&(inputDom.value=results[0].formatted_address)})})}function initData(){new geoXML3.parser({afterParse:function(docs){_doc=docs[0]}}).parse(kml)}function initInput(){var service=new google.maps.places.AutocompleteService;inputDom.addEventListener("input",function(){var query=inputDom.value;query?service.getPlacePredictions({input:query,componentRestrictions:{country:["hk"]}},function(results,status){if(status===google.maps.places.PlacesServiceStatus.OK){predictions.innerHTML="";for(var i=0;i<results.length;i++){var li=document.createElement("li");li.textContent=results[i].description,li.addEventListener("click",onSelect.bind(null,results[i])),predictions.appendChild(li)}}}):predictionsDom.innerHTML=""})}function onSelect(prediction){predictionsDom.innerHTML="",inputDom.value=prediction.description,getArea(prediction.description)}function initQueryBtn(){queryAddrBtn.addEventListener("click",function(){getArea(inputDom.value)})}function getArea(address){(new google.maps.Geocoder).geocode({address:address,componentRestrictions:{country:"HK"}},function(results,status){if(console.log("results",address,results),results[0],previousPin&&previousPin.setMap(null),"OK"===status){var location=results[0].geometry.location;if(kmlLayer.getDefaultViewport().contains(location))for(var i=0;i<_doc.gpolygons.length;i++){var polygon=_doc.gpolygons[i];if(console.log(polygon),google.maps.geometry.poly.containsLocation(location,polygon)){map.setCenter(location),map.setZoom(15),marker=new google.maps.Marker({position:location,map:map}),previousPin=marker,deliveryInfoDom.innerHTML=polygon.title;break}}else deliveryInfoDom.innerHTML=address+" 在配送範圍以外"}else deliveryInfoDom.innerHTML="網絡錯誤："+status})}